<!DOCTYPE html>
<html>
<head>
    <title>Advanced Audio Stream Player</title>
    <style>
        .player-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .progress-container {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: #4CAF50;
            border-radius: 10px;
            width: 0%;
            transition: width 0.1s;
        }
        .buffer-bar {
            height: 100%;
            background: #c8e6c9;
            border-radius: 10px;
            width: 0%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            margin: 5px 0;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .play-btn { background: #4CAF50; color: white; }
        .pause-btn { background: #ff9800; color: white; }
        .stop-btn { background: #f44336; color: white; }
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .speed-control {
            margin: 10px 0;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="player-container">
    <h3>Advanced Audio Stream Player</h3>

    <div class="progress-container" id="progressContainer">
        <div class="buffer-bar" id="bufferBar"></div>
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="time-display">
        <span id="currentTime">00:00</span>
        <span id="totalTime">00:00</span>
    </div>

    <div class="controls">
        <button class="play-btn" onclick="playPause()">Play</button>
        <button class="pause-btn" onclick="pauseAudio()">Pause</button>
        <button class="stop-btn" onclick="stopAudio()">Stop</button>
        <button onclick="skipBackward()">-10s</button>
        <button onclick="skipForward()">+10s</button>
    </div>

    <div class="volume-container">
        <span>Volume:</span>
        <input type="range" id="volumeSlider" min="0" max="100" value="100"
               oninput="changeVolume(this.value)">
        <span id="volumeValue">100%</span>
    </div>

    <div class="speed-control">
        <label>Playback Speed:</label>
        <select id="speedSelect" onchange="changeSpeed(this.value)">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
        </select>
    </div>

    <div class="status" id="status">Ready to play</div>

    <!-- Скрытый audio элемент для базового функционала -->
    <audio id="audioElement" preload="none"></audio>
</div>

<script>
    class AdvancedAudioPlayer {
        constructor() {
            this.audioElement = document.getElementById('audioElement');
            this.baseUrl = 'http://localhost:8080/api/v1/audio';
            this.currentSongId = null;
            this.isPlaying = false;

            // Элементы UI
            this.progressBar = document.getElementById('progressBar');
            this.bufferBar = document.getElementById('bufferBar');
            this.progressContainer = document.getElementById('progressContainer');
            this.currentTimeDisplay = document.getElementById('currentTime');
            this.totalTimeDisplay = document.getElementById('totalTime');
            this.statusElement = document.getElementById('status');
            this.volumeSlider = document.getElementById('volumeSlider');
            this.volumeValue = document.getElementById('volumeValue');

            this.initializeEventListeners();
        }

        initializeEventListeners() {
            // Прогресс воспроизведения
            this.audioElement.addEventListener('timeupdate', () => this.updateProgress());

            // Буферизация
            this.audioElement.addEventListener('progress', () => this.updateBuffer());
            this.audioElement.addEventListener('loadedmetadata', () => this.updateDuration());

            // Состояния воспроизведения
            this.audioElement.addEventListener('play', () => this.onPlay());
            this.audioElement.addEventListener('pause', () => this.onPause());
            this.audioElement.addEventListener('ended', () => this.onEnded());
            this.audioElement.addEventListener('waiting', () => this.onWaiting());
            this.audioElement.addEventListener('canplay', () => this.onCanPlay());
            this.audioElement.addEventListener('error', (e) => this.onError(e));

            // Обработка кликов по прогресс-бару
            this.progressContainer.addEventListener('click', (e) => this.seek(e));
        }

        async loadSong(songId) {
            this.currentSongId = songId;
            const streamUrl = `${this.baseUrl}/stream/${songId}`;

            this.audioElement.src = streamUrl;
            this.updateStatus('Loading song...');

            // Предзагрузка метаданных
            try {
                await new Promise((resolve, reject) => {
                    this.audioElement.addEventListener('loadedmetadata', resolve, { once: true });
                    this.audioElement.addEventListener('error', reject, { once: true });
                });
                this.updateStatus('Song loaded - Ready to play');
            } catch (error) {
                this.updateStatus('Error loading song: ' + error.message);
            }
        }

        playPause() {
            if (this.audioElement.paused) {
                this.audioElement.play().catch(error => {
                    this.updateStatus('Playback failed: ' + error.message);
                });
            } else {
                this.audioElement.pause();
            }
        }

        pauseAudio() {
            this.audioElement.pause();
        }

        stopAudio() {
            this.audioElement.pause();
            this.audioElement.currentTime = 0;
            this.updateProgress();
            this.updateStatus('Stopped');
        }

        skipBackward() {
            this.audioElement.currentTime = Math.max(0, this.audioElement.currentTime - 10);
        }

        skipForward() {
            this.audioElement.currentTime = Math.min(
                this.audioElement.duration,
                this.audioElement.currentTime + 10
            );
        }

        seek(event) {
            const rect = this.progressContainer.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            const seekTime = percent * this.audioElement.duration;

            this.audioElement.currentTime = seekTime;
            this.updateStatus(`Seeked to ${this.formatTime(seekTime)}`);
        }

        changeVolume(volume) {
            this.audioElement.volume = volume / 100;
            this.volumeValue.textContent = `${volume}%`;
        }

        changeSpeed(speed) {
            this.audioElement.playbackRate = parseFloat(speed);
            this.updateStatus(`Playback speed: ${speed}x`);
        }

        updateProgress() {
            if (this.audioElement.duration) {
                const percent = (this.audioElement.currentTime / this.audioElement.duration) * 100;
                this.progressBar.style.width = percent + '%';
                this.currentTimeDisplay.textContent = this.formatTime(this.audioElement.currentTime);
            }
        }

        updateBuffer() {
            if (this.audioElement.buffered.length > 0) {
                const bufferedEnd = this.audioElement.buffered.end(this.audioElement.buffered.length - 1);
                const duration = this.audioElement.duration;

                if (duration > 0) {
                    const bufferPercent = (bufferedEnd / duration) * 100;
                    this.bufferBar.style.width = bufferPercent + '%';
                }
            }
        }

        updateDuration() {
            if (this.audioElement.duration) {
                this.totalTimeDisplay.textContent = this.formatTime(this.audioElement.duration);
            }
        }

        // Обработчики событий состояния
        onPlay() {
            this.isPlaying = true;
            this.updateStatus('Playing');
        }

        onPause() {
            this.isPlaying = false;
            this.updateStatus('Paused');
        }

        onEnded() {
            this.isPlaying = false;
            this.updateStatus('Playback completed');
        }

        onWaiting() {
            this.updateStatus('Buffering...');
        }

        onCanPlay() {
            this.updateStatus('Ready to play');
        }

        onError(event) {
            const error = this.audioElement.error;
            let message = 'Unknown error';

            switch(error.code) {
                case error.MEDIA_ERR_ABORTED:
                    message = 'Playback was aborted';
                    break;
                case error.MEDIA_ERR_NETWORK:
                    message = 'Network error occurred';
                    break;
                case error.MEDIA_ERR_DECODE:
                    message = 'Audio decoding error';
                    break;
                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                    message = 'Audio format not supported';
                    break;
            }

            this.updateStatus('Error: ' + message);
        }

        updateStatus(message) {
            this.statusElement.textContent = message;
            console.log('Player status:', message);
        }

        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    }

    // Инициализация плеера
    const audioPlayer = new AdvancedAudioPlayer();

    // Глобальные функции для кнопок
    function playPause() {
        audioPlayer.playPause();
    }

    function pauseAudio() {
        audioPlayer.pauseAudio();
    }

    function stopAudio() {
        audioPlayer.stopAudio();
    }

    function skipBackward() {
        audioPlayer.skipBackward();
    }

    function skipForward() {
        audioPlayer.skipForward();
    }

    function changeVolume(value) {
        audioPlayer.changeVolume(value);
    }

    function changeSpeed(value) {
        audioPlayer.changeSpeed(value);
    }

    // Загрузка песни по умолчанию при загрузке страницы
    window.addEventListener('load', () => {
        audioPlayer.loadSong(1); // Загружаем песню с ID 1
    });
</script>
</body>
</html>